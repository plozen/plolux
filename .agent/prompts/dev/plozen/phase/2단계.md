# 2단계: 관리자 시스템 고도화

## 🎯 단계 목표

1단계에서 구현된 핵심 기능을 바탕으로, 실제 운영에 필요한 관리자 시스템을 완성하고 인증/권한 체계를 고도화합니다.

## 📅 예상 기간: 2-3일

## 🎯 주요 과업

### 1. 어드민 로그인/인증 개선

**현재 상태:** 기본 로그인만 구현
**목표:** 안전하고 편리한 관리자 인증 시스템

#### 구현 항목:

- [ ] **이중 인증 (2FA):** 이메일/SMS 인증 코드
- [ ] **소셜 로그인:** Google, GitHub OAuth 연동
- [ ] **세션 관리:** 자동 로그아웃, remember me
- [ ] **비밀번호 정책:** 복잡도 요구사항, 만료 기간
- [ ] **로그인 기록:** IP, 시간, 기록 추적
- [ ] **계정 잠금:** 실패 횟수 제한

#### 보안 강화:

```typescript
// Supabase Auth 활용
const adminAuth = {
  signIn: async (email: string, password: string) => {
    const { data, error } = await supabase.auth.signInWithPassword({
      email,
      password,
      options: {
        captchaToken: await getCaptchaToken(),
      },
    });
    return { data, error };
  },

  enable2FA: async (userId: string) => {
    const { error } = await supabase.auth.mfa.enroll({
      factorType: 'totp',
    });
    return error;
  },
};
```

### 2. 권한 관리 시스템

**목표:** 역할 기반 접근 제어 (RBAC) 구현

#### 구현 항목:

- [ ] **역할 정의:** Super Admin, Admin, Editor, Viewer
- [ ] **권한 테이블:** 기능별 접근 권한 정의
- [ ] **미들웨어:** 라우트별 권한 체크
- [ ] **UI 권한:** 버튼/메뉴 노출 제어
- [ ] **API 권한:** 엔드포인트별 접근 제어

#### 데이터 모델:

```sql
-- 권한 관리 테이블
CREATE TABLE admin_roles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(50) NOT NULL UNIQUE,
  description TEXT,
  permissions JSONB NOT NULL DEFAULT '[]',
  created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE admin_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  role_id UUID REFERENCES admin_roles(id),
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 3. 문의 상태 관리 시스템

**목표:** 문의 생명주기 관리 및 자동화

#### 구현 항목:

- [ ] **상태 정의:** 접수, 검토중, 답변완료, 보류, 완료
- [ ] **상태 변경 로그:** 누가, 언제, 어떻게 변경했는지
- [ ] **자동 상태 변경:** 답변 시 '답변완료'로 변경
- [ ] **상태 기반 필터링:** 상태별 문의 목록
- [ ] **알림 연동:** 상태 변경 시 관리자 알림

#### 상태 머신:

```typescript
type InquiryStatus = 'received' | 'reviewing' | 'answered' | 'pending' | 'completed';

const statusTransitions: Record<InquiryStatus, InquiryStatus[]> = {
  received: ['reviewing', 'pending'],
  reviewing: ['answered', 'pending'],
  answered: ['completed'],
  pending: ['reviewing'],
  completed: [],
};
```

### 4. 알림 시스템 기본 구현

**목표:** 실시간 관리자 알림 시스템

#### 구현 항목:

- [ ] **알림 종류:** 신규 문의, 견적 접수, 상태 변경
- [ ] **알림 채널:** 인앱 알림, 이메일
- [ ] **알림 설정:** 사용자별 알림 수신 설정
- [ ] **알림 기록:** 알림 발송 내역 관리
- [ ] **실시간 업데이트:** Server-Sent Events 활용

#### 알림 데이터 모델:

```sql
CREATE TABLE notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id),
  type VARCHAR(50) NOT NULL,
  title VARCHAR(200) NOT NULL,
  content TEXT,
  is_read BOOLEAN DEFAULT false,
  metadata JSONB,
  created_at TIMESTAMP DEFAULT NOW()
);
```

## 🛠️ 기술 구현 방안

### 1. 인증 미들웨어

```typescript
// middleware.ts
export async function middleware(request: NextRequest) {
  const { pathname } = request.nextUrl;

  // 어드민 경로 보호
  if (pathname.startsWith('/admin')) {
    const token = request.cookies.get('sb-access-token')?.value;

    if (!token) {
      return NextResponse.redirect(new URL('/admin/login', request.url));
    }

    // 권한 체크
    const hasPermission = await checkAdminPermission(token, pathname);
    if (!hasPermission) {
      return NextResponse.redirect(new URL('/admin/unauthorized', request.url));
    }
  }

  return NextResponse.next();
}
```

### 2. 실시간 알림 (SSE)

```typescript
// /api/notifications/stream
export async function GET(request: Request) {
  const stream = new ReadableStream({
    start(controller) {
      const interval = setInterval(async () => {
        const notifications = await getUnreadNotifications(userId);
        controller.enqueue(`data: ${JSON.stringify(notifications)}\n\n`);
      }, 5000);

      request.signal.addEventListener('abort', () => {
        clearInterval(interval);
        controller.close();
      });
    },
  });

  return new Response(stream, {
    headers: {
      'Content-Type': 'text/event-stream',
      'Cache-Control': 'no-cache',
      Connection: 'keep-alive',
    },
  });
}
```

### 3. 권한 체크 훅

```typescript
const usePermissions = () => {
  const { user } = useAuth();

  const hasPermission = useCallback(
    (permission: string) => {
      if (!user) return false;

      return user.permissions.includes(permission);
    },
    [user],
  );

  const canAccess = useCallback(
    (resource: string, action: string) => {
      return hasPermission(`${resource}:${action}`);
    },
    [hasPermission],
  );

  return { hasPermission, canAccess };
};
```

## 🎨 UI/UX 개선

### 1. 관리자 대시보드 개선

- [ ] 위젯 드래그 앤 드롭 재배치
- [ ] 실시간 데이터 업데이트 표시
- [ ] 퀵 액션 버튼 (신규 문의, 견적 등)
- [ ] 개인화된 대시보드 설정

### 2. 네비게이션 개선

- [ ] 브레드크럼 추가
- [ ] 즐겨찾기 메뉴 기능
- [ ] 검색 기능 (메뉴, 페이지)
- [ ] 키보드 단축키 지원

### 3. 알림 UI

- [ ] 토스트 알림 컴포넌트
- [ ] 알림 센터 (드롭다운/전용 페이지)
- [ ] 알림 설정 패널
- [ ] 읽음/안읽음 상태 표시

## ✅ 완료 기준

### 보안 기준:

- [ ] 모든 어드민 페이지 인증 보장
- [ ] 2FA 설정 가능 및 작동
- [ ] 권한 없는 접근 차단
- [ ] 세션 타임아웃 정상 작동

### 기능 기준:

- [ ] 역할별 권한 정상 작동
- [ ] 문의 상태 변경 및 로깅
- [ ] 실시간 알림 수신 가능
- [ ] 로그인 기록 조회 가능

### 사용성 기준:

- [ ] 로그인 프로세스 3단계 이내
- [ ] 알림 5초 내 수신
- [ ] 권한 변경 즉시 적용
- [ ] 모바일에서도 관리자 기능 사용 가능

## 🚀 다음 단계 준비

- 3단계 UX/UI 개선을 위한 컴포넌트 라이브러리 확장
- 알림 시스템 확장을 위한 이벤트 버스 아키텍처
- 권한 시스템 확장을 위한 동적 권한 로딩 기반 구축

---

_본 단계가 완료되면 안전하고 효율적인 관리자 시스템이 구축됩니다_
