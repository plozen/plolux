# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json
# ì›Œí¬í”Œë¡œ ì´ë¦„: Plolux í†µí•© ë°°í¬
name: Plolux í†µí•© ë°°í¬

# íŠ¸ë¦¬ê±° ì„¤ì •: main ë¸Œëœì¹˜ì— push ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì›Œí¬í”Œë¡œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
on:
  push:
    branches:
      - main

#ï¸âƒ£ [ì¶”ê°€] ìµœìƒë‹¨ ê¶Œí•œì„ ëª…ì‹œ (jobë³„ ê¶Œí•œë³´ë‹¤ ëª…í™•)
permissions:
  contents: read
  pages: write
  id-token: write

#ï¸âƒ£ [ì¶”ê°€] Pages ë°°í¬ëŠ” ë™ì‹œ ì‹¤í–‰ë³´ë‹¤ ì§ì „ ì‹¤í–‰ ì·¨ì†Œê°€ ì•ˆì „
concurrency:
  group: 'pages'
  cancel-in-progress: true

# ì‹¤í–‰ë  ì‘ì—…(Job)ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
jobs:
  # 'changes' ì‘ì—…: íŒ¨í‚¤ì§€ ë³€ê²½ ê°ì§€
  changes:
    name: ë³€ê²½ ì‚¬í•­ ê°ì§€
    runs-on: ubuntu-latest
    outputs:
      plozen: ${{ steps.filter.outputs.plozen }}
      plolux: ${{ steps.filter.outputs.plolux }}
      kcl: ${{ steps.filter.outputs.kcl }}
    steps:
      - name: ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ë³€ê²½ëœ íŒŒì¼ ê²½ë¡œ í•„í„°ë§
        uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            plozen:
              - 'packages/plozen/**'
            plolux:
              - 'packages/plolux/**'
            kcl:
              - 'packages/kcl/**'

  # 'build-and-deploy' ì‘ì—…: ì½”ë“œë¥¼ ë¹Œë“œí•˜ê³  GitHub Pagesì— ë°°í¬í•©ë‹ˆë‹¤.
  build-and-deploy:
    name: ë¹Œë“œ ë° ë°°í¬
    env:
      DEPLOY_TARGET: gh-pages
    needs: changes
    # ì‹¤í–‰ ì¡°ê±´:
    # 1. [no-deploy] íƒœê·¸ê°€ ì—†ì„ ê²ƒ
    # 2. plolux íŒ¨í‚¤ì§€ê°€ ë³€ê²½ë˜ì—ˆê±°ë‚˜, [deploy:plolux] ë˜ëŠ” [deploy:all] íƒœê·¸ê°€ ìˆì„ ë•Œ
    # NOTE: kcl, plozenì€ SSRì´ ìˆì–´ GitHub Pages ë°°í¬ ë¶ˆê°€ â†’ syncë§Œ ì‹¤í–‰
    if: |
      !contains(github.event.head_commit.message, '[no-deploy]') &&
      (needs.changes.outputs.plolux == 'true' || contains(github.event.head_commit.message, '[deploy:plolux]') || contains(github.event.head_commit.message, '[deploy:all]'))
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
      # -------------------------------------------------------------
      # 1. í™˜ê²½ ì„¤ì • ë° ì˜ì¡´ì„± ì„¤ì¹˜
      # -------------------------------------------------------------
      - name: ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v3
        with:
          version: latest

      - name: Node.js ì„¤ì¹˜ (22.x ë²„ì „)
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: pnpm ì˜ì¡´ì„± ìºì‹œ ë³µì›
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: ë¹Œë“œ í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: sudo apt-get update && sudo apt-get install -y build-essential python3 python-is-python3

      - name: ê¸°ì¡´ node_modules ë””ë ‰í† ë¦¬ ì •ë¦¬
        run: |
          rm -rf node_modules
          find . -name "node_modules" -type d -prune -exec rm -rf '{}' +

      - name: pnpm ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          pnpm install --frozen-lockfile
          echo "âœ… Dependencies installed successfully."

      # -------------------------------------------------------------
      # 2. ë¹Œë“œ ë° ì•„í‹°íŒ©íŠ¸ ì¤€ë¹„
      # -------------------------------------------------------------
      - name: ìµœì¢… ë°°í¬ ê²°ê³¼ë¬¼ì„ ë‹´ì„ 'staging' ë””ë ‰í† ë¦¬ ìƒì„±
        run: mkdir -p staging

      - name: ë£¨íŠ¸ index.htmlì„ 'staging'ìœ¼ë¡œ ë³µì‚¬
        run: cp index.html staging/

      - name: plolux íŒ¨í‚¤ì§€ ë¹Œë“œ
        run: |
          echo "ğŸš€ Building plolux..."
          pnpm --filter plolux build
          echo "âœ… plolux build complete."

      - name: plolux ë¹Œë“œ ê²°ê³¼ë¬¼ì„ 'staging'ìœ¼ë¡œ ë³µì‚¬
        run: |
          # plolux ë””ë ‰í† ë¦¬ ìƒì„± (URL: /plolux/plolux -> Repo:plolux + Dir:plolux)
          mkdir -p staging/plolux

          # GitHub Pagesì—ì„œ _next í´ë” ì¸ì‹ì„ ìœ„í•´ .nojekyll íŒŒì¼ ìƒì„±
          touch staging/.nojekyll

          # Next.js output: export ëª¨ë“œì¼ ê²½ìš° 'out' í´ë”ê°€ ìƒì„±ë¨
          # ì£¼ì˜: next.config.tsì—ì„œ output: 'export' ì„¤ì • í•„ìš”
          cp -r packages/plolux/out/* staging/plolux/ || { echo "âŒ 'plolux out' directory not found."; exit 1; }
          echo "ğŸ“¦ plolux copied to staging/plolux."

      # NOTE: kcl, plozenì€ SSR/API ë¼ìš°íŠ¸ê°€ ìˆì–´ GitHub Pages ë°°í¬ ë¶ˆê°€
      # í•´ë‹¹ íŒ¨í‚¤ì§€ë“¤ì€ sync jobì„ í†µí•´ ë³„ë„ ë¦¬í¬ì§€í† ë¦¬ë¡œ ì „ì†¡ í›„ Vercel ë“±ì—ì„œ ë°°í¬

      # -------------------------------------------------------------
      # GitHub Pages ì—…ë¡œë“œ ë° ë°°í¬
      # -------------------------------------------------------------
      - name: staging ë””ë ‰í† ë¦¬ë¥¼ ë°°í¬ ì•„í‹°íŒ©íŠ¸ë¡œ ì—…ë¡œë“œ
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'staging'

      - name: GitHub Pagesì— ë°°í¬
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact_name: github-pages

  # [New] Sync specific package to independent repository for Delivery
  sync-to-plozen-web:
    runs-on: ubuntu-latest
    needs: [] # Run in parallel with documentation deploy
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync App to Plozen Repo
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.FORJEX_SYNC_TOKEN }}
        with:
          source-directory: 'packages/plozen'
          destination-github-username: 'plozen'
          destination-repository-name: 'plozen-web'
          user-email: 'devops@plozen.com'
          target-branch: 'main'
          create-target-branch-if-needed: true
          commit-message: 'Ship: Plozen Engine Update (ORIGIN_COMMIT)'

  sync-to-plolux-web:
    runs-on: ubuntu-latest
    needs: [] # Run in parallel with documentation deploy
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync App to Plolux Repo
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.FORJEX_SYNC_TOKEN }}
        with:
          source-directory: 'packages/plolux'
          destination-github-username: 'plozen'
          destination-repository-name: 'plolux-web'
          user-email: 'devops@plozen.com'
          target-branch: 'main'
          create-target-branch-if-needed: true
          commit-message: 'Ship: Plolux Engine Update (ORIGIN_COMMIT)'

  sync-to-kcl:
    runs-on: ubuntu-latest
    needs: [] # Run in parallel
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync App to KCL Repo
        uses: cpina/github-action-push-to-another-repository@main
        env:
          API_TOKEN_GITHUB: ${{ secrets.FORJEX_SYNC_TOKEN }}
        with:
          source-directory: 'packages/kcl'
          destination-github-username: 'plozen'
          destination-repository-name: 'kcl'
          user-email: 'devops@plozen.com'
          target-branch: 'main'
          create-target-branch-if-needed: true
          commit-message: 'Ship: KCL Update (ORIGIN_COMMIT)'
